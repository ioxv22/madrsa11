import React, { useState, useEffect, useCallback } from 'react';
import { useSearchParams, Link } from 'react-router-dom';
import { toast } from 'react-toastify';
import { 
  FaFile, 
  FaDownload, 
  FaSearch, 
  FaFilter,

  FaEdit,
  FaTrash,
  FaPlus,
  FaChevronLeft,
  FaChevronRight
} from 'react-icons/fa';
import { useAuth } from '../../context/AuthContext';
import fileService from '../../services/fileService';
import subjectService from '../../services/subjectService';
import LoadingSpinner from '../Common/LoadingSpinner';
import './FileList.css';

const FileList = () => {
  const { user } = useAuth();
  const [searchParams, setSearchParams] = useSearchParams();
  
  const [files, setFiles] = useState([]);
  const [subjects, setSubjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [pagination, setPagination] = useState({});
  
  // ููุงุชุฑ ุงูุจุญุซ
  const [filters, setFilters] = useState({
    search: searchParams.get('search') || '',
    subject_id: searchParams.get('subject') || '',
    file_type: searchParams.get('type') || '',
    sort: searchParams.get('sort') || 'created_at',
    order: searchParams.get('order') || 'desc',
    page: parseInt(searchParams.get('page')) || 1,
    limit: 12
  });

  const [showFilters, setShowFilters] = useState(false);

  // ุชุนุฑูู ุงูุฏูุงู ุฃููุงู
  const loadSubjects = async () => {
    try {
      const response = await subjectService.getAllSubjects();
      setSubjects(response.data);
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุชุญููู ุงูููุงุฏ:', error);
    }
  };

  const loadFiles = useCallback(async () => {
    try {
      setLoading(true);
      const response = await fileService.getFiles(filters);
      setFiles(response.data.files);
      setPagination(response.data.pagination);
    } catch (error) {
      console.error('ุฎุทุฃ ูู ุชุญููู ุงููููุงุช:', error);
      toast.error('ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงููููุงุช');
    } finally {
      setLoading(false);
    }
  }, [filters]);

  // useEffect hooks ุจุนุฏ ุชุนุฑูู ุงูุฏูุงู
  useEffect(() => {
    loadSubjects();
  }, []);

  useEffect(() => {
    loadFiles();
  }, [loadFiles]);

  useEffect(() => {
    // ุชุญุฏูุซ URL ุนูุฏ ุชุบููุฑ ุงูููุงุชุฑ
    const params = new URLSearchParams();
    Object.keys(filters).forEach(key => {
      if (filters[key] && key !== 'limit') {
        params.set(key, filters[key]);
      }
    });
    setSearchParams(params);
  }, [filters, setSearchParams]);

  const handleFilterChange = (key, value) => {
    setFilters(prev => ({
      ...prev,
      [key]: value,
      page: key !== 'page' ? 1 : value // ุฅุนุงุฏุฉ ุชุนููู ุงูุตูุญุฉ ุนูุฏ ุชุบููุฑ ุงูููุงุชุฑ
    }));
  };

  const handleDownload = async (fileId, filename) => {
    try {
      await fileService.downloadFile(fileId, filename);
      toast.success('ุชู ุชุญููู ุงูููู ุจูุฌุงุญ');
      // ุฅุนุงุฏุฉ ุชุญููู ุงููููุงุช ูุชุญุฏูุซ ุนุฏุงุฏ ุงูุชุญููู
      loadFiles();
    } catch (error) {
      toast.error('ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูููู');
    }
  };

  const handleDeleteFile = async (fileId, filename) => {
    if (!window.confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููู "${filename}"ุ`)) {
      return;
    }

    try {
      await fileService.deleteFile(fileId);
      toast.success('ุชู ุญุฐู ุงูููู ุจูุฌุงุญ');
      loadFiles();
    } catch (error) {
      const errorMessage = error.response?.data?.message || 'ุญุฏุซ ุฎุทุฃ ูู ุญุฐู ุงูููู';
      toast.error(errorMessage);
    }
  };

  const getFileIcon = (filename) => {
    const extension = filename.split('.').pop().toLowerCase();
    const iconMap = {
      pdf: '๐',
      doc: '๐', docx: '๐',
      ppt: '๐', pptx: '๐',
      xls: '๐', xlsx: '๐',
      jpg: '๐ผ๏ธ', jpeg: '๐ผ๏ธ', png: '๐ผ๏ธ', gif: '๐ผ๏ธ',
      mp4: '๐ฅ', avi: '๐ฅ', mov: '๐ฅ',
      mp3: '๐ต', wav: '๐ต',
      zip: '๐ฆ', rar: '๐ฆ'
    };
    return iconMap[extension] || '๐';
  };

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  const getSubjectName = (subjectId) => {
    const subject = subjects.find(s => s.id === subjectId);
    return subject ? subject.name_ar : 'ุบูุฑ ูุญุฏุฏ';
  };

  if (loading && filters.page === 1) {
    return <LoadingSpinner message="ุฌุงุฑู ุชุญููู ุงููููุงุช..." />;
  }

  return (
    <div className="file-list-container">
      <div className="page-header">
        <div className="header-content">
          <h1>
            <FaFile />
            ุงููููุงุช ุงูุฏุฑุงุณูุฉ
          </h1>
          <p>ุชุตูุญ ูุญูู ุฌููุน ุงููููุงุช ุงูุฏุฑุงุณูุฉ ุงููุชุงุญุฉ</p>
        </div>
        
        {user.role === 'admin' && (
          <Link to="/admin/upload" className="btn btn-primary">
            <FaPlus />
            ุฑูุน ููู ุฌุฏูุฏ
          </Link>
        )}
      </div>

      {/* ุดุฑูุท ุงูุจุญุซ ูุงูููุงุชุฑ */}
      <div className="search-filters-section">
        <div className="search-container">
          <FaSearch className="search-icon" />
          <input
            type="text"
            placeholder="ุงูุจุญุซ ูู ุงููููุงุช..."
            value={filters.search}
            onChange={(e) => handleFilterChange('search', e.target.value)}
            className="search-input"
          />
        </div>
        
        <button
          className={`filter-toggle ${showFilters ? 'active' : ''}`}
          onClick={() => setShowFilters(!showFilters)}
        >
          <FaFilter />
          ุงูููุงุชุฑ
        </button>
      </div>

      {/* ุงูููุงุชุฑ ุงููุชูุฏูุฉ */}
      {showFilters && (
        <div className="filters-panel">
          <div className="filter-group">
            <label>ุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ:</label>
            <select
              value={filters.subject_id}
              onChange={(e) => handleFilterChange('subject_id', e.target.value)}
            >
              <option value="">ุฌููุน ุงูููุงุฏ</option>
              {subjects.map(subject => (
                <option key={subject.id} value={subject.id}>
                  {subject.name_ar}
                </option>
              ))}
            </select>
          </div>

          <div className="filter-group">
            <label>ููุน ุงูููู:</label>
            <select
              value={filters.file_type}
              onChange={(e) => handleFilterChange('file_type', e.target.value)}
            >
              <option value="">ุฌููุน ุงูุฃููุงุน</option>
              <option value="pdf">PDF</option>
              <option value="image">ุตูุฑ</option>
              <option value="video">ููุฏูู</option>
              <option value="document">ูุณุชูุฏุงุช</option>
            </select>
          </div>

          <div className="filter-group">
            <label>ุชุฑุชูุจ ุญุณุจ:</label>
            <select
              value={`${filters.sort}-${filters.order}`}
              onChange={(e) => {
                const [sort, order] = e.target.value.split('-');
                handleFilterChange('sort', sort);
                handleFilterChange('order', order);
              }}
            >
              <option value="created_at-desc">ุงูุฃุญุฏุซ</option>
              <option value="created_at-asc">ุงูุฃูุฏู</option>
              <option value="title-asc">ุงูุงุณู (ุฃ-ู)</option>
              <option value="title-desc">ุงูุงุณู (ู-ุฃ)</option>
              <option value="download_count-desc">ุงูุฃูุซุฑ ุชุญูููุงู</option>
              <option value="file_size-desc">ุงูุฃูุจุฑ ุญุฌูุงู</option>
              <option value="file_size-asc">ุงูุฃุตุบุฑ ุญุฌูุงู</option>
            </select>
          </div>

          <button
            className="clear-filters"
            onClick={() => {
              setFilters({
                search: '',
                subject_id: '',
                file_type: '',
                sort: 'created_at',
                order: 'desc',
                page: 1,
                limit: 12
              });
            }}
          >
            ูุณุญ ุงูููุงุชุฑ
          </button>
        </div>
      )}

      {/* ูุนูููุงุช ุงููุชุงุฆุฌ */}
      <div className="results-info">
        <span>
          {pagination.totalFiles || 0} ููู
          {filters.search && ` โข ุงูุจุญุซ ุนู: "${filters.search}"`}
          {filters.subject_id && ` โข ุงููุงุฏุฉ: ${getSubjectName(parseInt(filters.subject_id))}`}
        </span>
      </div>

      {/* ูุงุฆูุฉ ุงููููุงุช */}
      {files.length === 0 ? (
        <div className="empty-state">
          <div className="empty-icon">๐</div>
          <h3>ูุง ุชูุฌุฏ ูููุงุช</h3>
          <p>
            {filters.search || filters.subject_id || filters.file_type
              ? 'ูู ูุชู ุงูุนุซูุฑ ุนูู ูููุงุช ุชุทุงุจู ุงูููุงุชุฑ ุงููุญุฏุฏุฉ'
              : 'ูู ูุชู ุฑูุน ุฃู ูููุงุช ุจุนุฏ'
            }
          </p>
          {user.role === 'admin' && !filters.search && !filters.subject_id && (
            <Link to="/admin/upload" className="btn btn-primary">
              <FaPlus />
              ุฑูุน ููู ุฌุฏูุฏ
            </Link>
          )}
        </div>
      ) : (
        <>
          <div className="files-grid">
            {files.map(file => (
              <div key={file.id} className="file-card">
                <div className="file-header">
                  <div className="file-icon">
                    {getFileIcon(file.original_name)}
                  </div>
                  <div className="file-actions">
                    {user.role === 'admin' && (
                      <>
                        <button
                          className="action-btn edit"
                          title="ุชุนุฏูู ุงูููู"
                        >
                          <FaEdit />
                        </button>
                        <button
                          className="action-btn delete"
                          onClick={() => handleDeleteFile(file.id, file.title)}
                          title="ุญุฐู ุงูููู"
                        >
                          <FaTrash />
                        </button>
                      </>
                    )}
                  </div>
                </div>

                <div className="file-content">
                  <h3 title={file.title}>{file.title}</h3>
                  {file.description && (
                    <p className="file-description">{file.description}</p>
                  )}
                  
                  <div className="file-meta">
                    <span className="subject-tag" style={{ backgroundColor: file.subject_color + '20', color: file.subject_color }}>
                      {file.subject_name}
                    </span>
                    <span className="file-type">
                      {fileService.getFileType(file.original_name)}
                    </span>
                    <span className="file-size">
                      {fileService.formatFileSize(file.file_size)}
                    </span>
                  </div>

                  <div className="file-stats">
                    <span className="upload-date">
                      {formatDate(file.created_at)}
                    </span>
                    <span className="download-count">
                      <FaDownload />
                      {file.download_count} ุชุญููู
                    </span>
                  </div>
                </div>

                <div className="file-footer">
                  <button
                    className="btn btn-primary btn-block"
                    onClick={() => handleDownload(file.id, file.original_name)}
                  >
                    <FaDownload />
                    ุชุญููู ุงูููู
                  </button>
                </div>
              </div>
            ))}
          </div>

          {/* ุงูุชููู ุจูู ุงูุตูุญุงุช */}
          {pagination.totalPages > 1 && (
            <div className="pagination">
              <button
                className="pagination-btn"
                disabled={!pagination.hasPrev}
                onClick={() => handleFilterChange('page', filters.page - 1)}
              >
                <FaChevronRight />
                ุงูุณุงุจู
              </button>

              <div className="pagination-info">
                <span>
                  ุงูุตูุญุฉ {pagination.currentPage} ูู {pagination.totalPages}
                </span>
              </div>

              <button
                className="pagination-btn"
                disabled={!pagination.hasNext}
                onClick={() => handleFilterChange('page', filters.page + 1)}
              >
                ุงูุชุงูู
                <FaChevronLeft />
              </button>
            </div>
          )}
        </>
      )}

      {loading && filters.page > 1 && (
        <div className="loading-more">
          <LoadingSpinner size="small" overlay={false} />
        </div>
      )}
    </div>
  );
};

export default FileList;